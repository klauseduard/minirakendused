<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZFD132PZ0Z"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        
        gtag('config', 'G-ZFD132PZ0Z', {
            'page_path': '/minirakendused/gardening_calendar'
        });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Gardening and Planting Calendar</title>
    <link rel="stylesheet" href="gardening_calendar/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Spring Gardening and Planting Calendar</h1>
            <div class="quick-jump-menu" id="quickJumpMenu">
                <div class="quick-jump-title">Quick Navigation:</div>
                <button class="quick-jump-btn" data-section="location-setup">
                    <span class="nav-icon">📍</span> Location
                </button>
                <button class="quick-jump-btn" data-section="weather-info">
                    <span class="nav-icon">🌤️</span> Weather
                </button>
                <button class="quick-jump-btn" data-section="search-section">
                    <span class="nav-icon">🤖</span> Search & AI
                </button>
                <button class="quick-jump-btn" data-section="monthly-calendar">
                    <span class="nav-icon">📅</span> Calendar
                </button>
                <button class="quick-jump-btn" data-section="garden-journal">
                    <span class="nav-icon">📔</span> Journal
                </button>
            </div>
        </header>

        <main class="main-layout">
            <!-- Location and Units Controls -->
            <section class="top-controls" id="location-setup">
                <div class="location-row">
                    <div class="location-input-group">
                        <label for="locationInput" class="visually-hidden">Location</label>
                        <input type="text" class="location-input" id="locationInput" 
                            placeholder="City or place name (e.g., Paris, Barcelona)" 
                            aria-label="Location">
                        <button type="button" id="clearLocationBtn" class="location-clear-btn" 
                            aria-label="Clear location">×</button>
                    </div>
                    <button class="location-action-btn search-location-btn" id="searchLocationBtn">
                        <span class="search-icon">🔍</span> Search
                    </button>
                    <button class="location-action-btn geo-location-btn" id="useMyLocationBtn">
                        <span class="location-icon">📍</span> My Location
                    </button>
                </div>
                <div class="units-row">
                    <div class="unit-group">
                        <label for="tempUnitSelect">Temperature:</label>
                        <select id="tempUnitSelect" aria-label="Temperature unit">
                            <option value="C">Celsius (°C)</option>
                            <option value="F">Fahrenheit (°F)</option>
                        </select>
                    </div>
                    <div class="unit-group">
                        <label for="precipUnitSelect">Precipitation:</label>
                        <select id="precipUnitSelect" aria-label="Precipitation unit">
                            <option value="mm">Millimeters (mm)</option>
                            <option value="in">Inches (in)</option>
                        </select>
                    </div>
                </div>
                <div id="climateZoneInfo"></div>
            </section>

            <!-- Weather Display -->
            <section class="weather-display" id="weather-info">
                <div class="weather-placeholder" id="weatherPlaceholder">
                    Weather information for your location will appear here.
                </div>
            </section>

            <!-- Search Bar -->
            <section class="search-bar" id="search-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="search-section-title">Search & AI Garden Assistant</h2>
                    <button id="aiAdviceBtn" class="ai-advice-btn" style="padding: 8px 16px; background: var(--secondary-color); color: white; border: none; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-weight: 500; cursor: pointer; transition: background-color 0.3s;">
                        <span style="font-size: 1.2em;">🤖</span>
                        <span>Generate AI gardening advice prompt</span>
                    </button>
                </div>
                <div class="search-container">
                    <label for="searchBox" class="visually-hidden">Search for plants or tasks</label>
                    <input type="text" class="search-box" id="searchBox" 
                        placeholder="Type to search for specific plants or garden tasks..." 
                        aria-label="Search for plants or tasks">
                </div>
            </section>

            <!-- Month Navigation -->
            <section class="month-navigation" id="monthly-calendar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="month-nav-title">Select Growing Period</h2>
                </div>
                <div class="calendar-nav">
                    <button class="month-btn active" data-month="april">April</button>
                    <button class="month-btn" data-month="may">May</button>
                    <button class="month-btn" data-month="early_june">Early June</button>
                </div>
            </section>

            <!-- Calendar Content -->
            <section class="calendar-content" id="calendarContent">
                <!-- Content will be added by JavaScript -->
            </section>

            <!-- Garden Journal Section -->
            <section class="garden-journal" id="garden-journal" style="display: none;">
                <div class="journal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="journal-title" style="color: var(--primary-color); font-size: 1.4rem;">Garden Journal</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportJournalBtn" class="journal-btn" style="padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-weight: 500; cursor: pointer; transition: background-color 0.3s;">
                            <span style="font-size: 1.1em;">📤</span>
                            <span>Export</span>
                        </button>
                        <button id="importJournalBtn" class="journal-btn" style="padding: 8px 12px; background: var(--primary-color); color: white; border: none; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-weight: 500; cursor: pointer; transition: background-color 0.3s;">
                            <span style="font-size: 1.1em;">📥</span>
                            <span>Import</span>
                        </button>
                        <button id="addJournalEntryBtn" class="journal-add-btn" style="padding: 8px 12px; background: var(--secondary-color); color: white; border: none; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-weight: 500; cursor: pointer; transition: background-color 0.3s;">
                            <span style="font-size: 1.1em;">➕</span>
                            <span>New Entry</span>
                        </button>
                    </div>
                </div>
                
                <div class="journal-tabs">
                    <button class="journal-tab active" data-view="timeline">Timeline</button>
                    <button class="journal-tab" data-view="gallery">Photo Gallery</button>
                    <button class="journal-tab" data-view="calendar">Calendar</button>
                </div>
                
                <div id="journalContent" class="journal-content" style="background: var(--white); border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px var(--shadow);">
                    <!-- Will be populated by JavaScript -->
                    <div id="emptyJournalMessage" style="text-align: center; padding: 40px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 20px;">📔</div>
                        <h3 style="margin-bottom: 15px; color: var(--primary-color);">Your Garden Journal is Empty</h3>
                        <p style="margin-bottom: 20px; color: #666;">Start documenting your gardening journey by adding your first entry!</p>
                        <button id="emptyJournalAddBtn" class="journal-add-btn" style="padding: 10px 20px; background: var(--secondary-color); color: white; border: none; border-radius: 20px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                            <span>➕</span> Add First Entry
                        </button>
                    </div>
                    
                    <div id="journalTimeline" style="display: none;">
                        <!-- Timeline entries will be added here -->
                    </div>
                    
                    <div id="journalGallery" style="display: none;">
                        <!-- Photo gallery will be added here -->
                    </div>
                    
                    <div id="journalCalendar" style="display: none;">
                        <!-- Calendar view will be added here -->
                    </div>
                </div>
            </section>

            <button class="scroll-to-top" id="scrollToTop" aria-label="Scroll to top" style="display: none;">
                ↑
            </button>
        </main>

        <!-- Prompt Generator Modal -->
        <div id="promptGeneratorModal" class="weather-modal-overlay" style="display: none;">
            <div class="weather-modal" style="width: 90%; max-width: 800px;">
                <button class="weather-modal-close" id="closePromptGeneratorBtn" aria-label="Close prompt generator">&times;</button>
                <div class="weather-modal-title">AI Gardening Assistant</div>
                <div style="margin: 20px 0;">
                    <p style="margin-bottom: 15px; color: #666;">
                        This tool will generate a comprehensive prompt based on your location, weather, and garden information. 
                        You can use this prompt with any AI assistant to get personalized gardening advice.
                    </p>
                    <div style="margin-bottom: 15px;">
                        <label for="customNotes" style="display: block; margin-bottom: 8px; font-weight: 500;">Your notes about your garden:</label>
                        <textarea id="customNotes" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; margin-bottom: 10px;" placeholder="Describe your garden's current state, what you've already done, or ask specific questions..."></textarea>
                    </div>
                    <div style="margin-bottom: 15px; padding: 12px; background: #fff3e0; border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; color: #e65100; font-size: 1rem;">Include in Prompt:</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <label style="display: block;">
                                <input type="checkbox" id="includeCalendar" checked>
                                Selected plants and tasks
                                <span style="margin-left: 5px; color: #666; font-size: 0.9em;">
                                    (Your checked items from the planting calendar)
                                </span>
                            </label>
                            <label style="display: block;">
                                <input type="checkbox" id="includeRelevantPlantsOnly" checked>
                                Filter for weather conditions
                                <span style="margin-left: 5px; color: #666; font-size: 0.9em;">
                                    (Only include plants suitable for current forecast)
                                </span>
                            </label>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button id="generatePromptBtn" class="location-btn">Generate Prompt</button>
                        <button id="copyPromptBtn" class="location-btn" style="background: var(--accent-color);">Copy to Clipboard</button>
                    </div>
                    <div id="generatedPrompt" style="background: #f8faf5; border-radius: 8px; padding: 15px; white-space: pre-wrap; font-family: monospace; max-height: 400px; overflow-y: auto;">
                        Click "Generate Prompt" to create a customized gardening prompt based on your location, weather, and calendar data.
                    </div>
                    
                    <!-- AI Assistants Integration -->
                    <div id="promptDestinationSection" style="margin-top: 20px; display: none;">
                        <h3 style="margin-bottom: 15px; font-size: 1.1rem; color: var(--primary-color);">Send Prompt Directly To:</h3>
                        <div class="ai-assistants-grid">
                            <button class="ai-assistant-btn" data-assistant="chatgpt">
                                <div class="ai-icon" style="background-color: #10a37f; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                                    </svg>
                                </div>
                                <span>ChatGPT</span>
                            </button>
                            <button class="ai-assistant-btn" data-assistant="claude">
                                <div class="ai-icon" style="background-color: #9A5CF2; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <path d="M12 16v-4"></path>
                                        <path d="M12 8h.01"></path>
                                    </svg>
                                </div>
                                <span>Claude</span>
                            </button>
                            <button class="ai-assistant-btn" data-assistant="gemini">
                                <div class="ai-icon" style="background-color: #1E88E5; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                    </svg>
                                </div>
                                <span>Gemini</span>
                            </button>
                            <button class="ai-assistant-btn" data-assistant="copilot">
                                <div class="ai-icon" style="background-color: #0F6CBD; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M9 18l6-6-6-6"></path>
                                    </svg>
                                </div>
                                <span>Copilot</span>
                            </button>
                            <button class="ai-assistant-btn" data-assistant="mistral">
                                <div class="ai-icon" style="background-color: #DE5833; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M20 12V8H6a2 2 0 1 1 0-4h12v4"></path>
                                        <path d="M4 12v4h14a2 2 0 1 1 0 4H4v-4"></path>
                                    </svg>
                                </div>
                                <span>Mistral</span>
                            </button>
                            <button class="ai-assistant-btn" data-assistant="deepseek">
                                <div class="ai-icon" style="background-color: #1B7A9F; color: white; border-radius: 8px;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="5"></circle>
                                        <line x1="12" y1="1" x2="12" y2="3"></line>
                                        <line x1="12" y1="21" x2="12" y2="23"></line>
                                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                                        <line x1="1" y1="12" x2="3" y2="12"></line>
                                        <line x1="21" y1="12" x2="23" y2="12"></line>
                                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                                    </svg>
                                </div>
                                <span>DeepSeek</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Journal Entry Modal -->
        <div id="journalEntryModal" class="weather-modal-overlay" style="display: none;">
            <div class="weather-modal" style="width: 90%; max-width: 800px;">
                <button class="weather-modal-close" id="closeJournalEntryBtn" aria-label="Close journal entry">&times;</button>
                <div class="weather-modal-title" id="journalEntryModalTitle">Add Journal Entry</div>
                <div style="margin: 20px 0;">
                    <form id="journalEntryForm">
                        <input type="hidden" id="journalEntryId">
                        
                        <div style="margin-bottom: 20px;">
                            <label for="entryDate" style="display: block; margin-bottom: 8px; font-weight: 500;">Date:</label>
                            <input type="date" id="entryDate" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="entryType" style="display: block; margin-bottom: 8px; font-weight: 500;">Entry Type:</label>
                            <select id="entryType" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;" required>
                                <option value="planting">🌱 Planting</option>
                                <option value="care">🌿 Garden Care</option>
                                <option value="harvest">🥕 Harvest</option>
                                <option value="observation">👁️ Observation</option>
                                <option value="maintenance">🧰 Maintenance</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="entryLocation" style="display: block; margin-bottom: 8px; font-weight: 500;">Location in Garden:</label>
                            <input type="text" id="entryLocation" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;" placeholder="e.g., North bed, Container #3">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="entryPlants" style="display: block; margin-bottom: 8px; font-weight: 500;">Plants:</label>
                            <select id="entryPlants" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;" multiple>
                                <!-- Will be populated from the calendar data -->
                            </select>
                            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                Hold Ctrl/Cmd to select multiple plants
                            </div>
                        </div>
                        
                        <div id="harvestMetricsContainer" style="margin-bottom: 20px; display: none;">
                            <h4 style="margin-bottom: 12px; color: var(--primary-color);">Harvest Metrics</h4>
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <label for="harvestQuantity" style="display: block; margin-bottom: 8px; font-weight: 500;">Quantity:</label>
                                    <input type="number" id="harvestQuantity" min="0" step="0.1" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;" placeholder="e.g., 2.5">
                                </div>
                                <div style="flex: 1;">
                                    <label for="harvestUnit" style="display: block; margin-bottom: 8px; font-weight: 500;">Unit:</label>
                                    <select id="harvestUnit" style="padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px; width: 100%;">
                                        <option value="kg">Kilograms (kg)</option>
                                        <option value="lb">Pounds (lb)</option>
                                        <option value="g">Grams (g)</option>
                                        <option value="oz">Ounces (oz)</option>
                                        <option value="count">Count (pieces)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label for="harvestQuality" style="display: block; margin-bottom: 8px; font-weight: 500;">Quality Rating:</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="range" id="harvestQuality" min="1" max="5" value="3" style="flex: 1;">
                                    <span id="qualityRatingText">Good</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label for="entryNotes" style="display: block; margin-bottom: 8px; font-weight: 500;">Notes:</label>
                            <textarea id="entryNotes" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--secondary-color); border-radius: 8px;" placeholder="Describe what you did, observed, or harvested..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Photos:</label>
                            <div id="photoUploadContainer" style="border: 2px dashed var(--secondary-color); border-radius: 8px; padding: 20px; text-align: center;">
                                <div id="dragDropText">
                                    <div style="font-size: 2rem; margin-bottom: 10px;">📷</div>
                                    <p>Drag and drop photos here or <label for="photoInput" style="color: var(--primary-color); cursor: pointer;">browse</label></p>
                                </div>
                                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                                <div id="photoPreviewContainer" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;"></div>
                            </div>
                            <div id="storageWarning" style="margin-top: 8px; font-size: 0.9em; color: #f57c00; display: none;">
                                Storage usage is high. Consider removing some photos or exporting your journal.
                            </div>
                            <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                                Photos will be automatically resized to save storage space. Maximum 5 photos per entry.
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button type="button" id="cancelJournalEntryBtn" style="padding: 10px 20px; background: #e0e0e0; color: #333; border: none; border-radius: 20px; font-weight: 500; cursor: pointer;">Cancel</button>
                            <button type="submit" id="saveJournalEntryBtn" style="padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 20px; font-weight: 500; cursor: pointer;">Save Entry</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <footer>
            <p>Spring Gardening and Planting Calendar © 2025</p>
        </footer>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="customConfirmModal" class="weather-modal-overlay" style="display: none; z-index: 1000;">
        <div class="weather-modal" style="max-width: 450px; padding: 25px;">
            <div id="confirmModalTitle" style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 15px;">Confirm Action</div>
            <div id="confirmModalMessage" style="margin-bottom: 25px; line-height: 1.5;">Message goes here</div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button id="confirmModalCancelBtn" class="button" style="background: #e0e0e0; color: #333; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">Cancel</button>
                <button id="confirmModalOkBtn" class="button" style="background: var(--primary-color); color: white; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div id="exportOptionsModal" class="weather-modal-overlay" style="display: none; z-index: 1000;">
        <div class="weather-modal" style="max-width: 450px; padding: 25px;">
            <button class="weather-modal-close" id="exportModalCloseBtn" aria-label="Close export options">&times;</button>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 15px;">Export Options</div>
            <div style="margin-bottom: 25px; line-height: 1.5;">Choose how you would like to export your journal:</div>
            
            <div class="export-option" style="display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; cursor: pointer;">
                <div style="margin-right: 15px; font-size: 1.5rem;">📷</div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 500;">Complete Export</div>
                    <div style="font-size: 0.9rem; color: #666;">Include all entries with images (larger file size)</div>
                </div>
            </div>
            
            <div class="export-option" style="display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                <div style="margin-right: 15px; font-size: 1.5rem;">📝</div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 500;">Lightweight Export</div>
                    <div style="font-size: 0.9rem; color: #666;">Text-only export without images (smaller file size)</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button id="exportOptionsCancelBtn" class="button" style="background: #e0e0e0; color: #333; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer; margin-right: 12px;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Options Modal -->
    <div id="importOptionsModal" class="weather-modal-overlay" style="display: none; z-index: 1000;">
        <div class="weather-modal" style="max-width: 450px; padding: 25px;">
            <button class="weather-modal-close" id="importModalCloseBtn" aria-label="Close import options">&times;</button>
            <div style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 15px;">Import Options</div>
            <div id="importStatsMessage" style="margin-bottom: 25px; line-height: 1.5;">Found entries to import.</div>
            
            <div class="import-option" style="display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 12px; cursor: pointer;">
                <div style="margin-right: 15px; font-size: 1.5rem;">🔄</div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 500;">Merge</div>
                    <div style="font-size: 0.9rem; color: #666;">Add new entries and update existing ones</div>
                </div>
            </div>
            
            <div class="import-option" style="display: flex; align-items: center; padding: 12px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
                <div style="margin-right: 15px; font-size: 1.5rem;">♻️</div>
                <div style="flex-grow: 1;">
                    <div style="font-weight: 500;">Replace All</div>
                    <div style="font-size: 0.9rem; color: #666;">Delete all existing entries and use imported ones</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                <button id="importOptionsCancelBtn" class="button" style="background: #e0e0e0; color: #333; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="weather-modal-overlay" style="display: none; z-index: 1000;">
        <div class="weather-modal" style="max-width: 450px; padding: 25px;">
            <button class="weather-modal-close" id="deleteModalCloseBtn" aria-label="Close delete confirmation">&times;</button>
            <div style="font-size: 1.2rem; font-weight: 600; color: #d32f2f; margin-bottom: 15px;">Delete Entry</div>
            <div style="margin-bottom: 25px; line-height: 1.5;">Are you sure you want to delete this journal entry? This action cannot be undone.</div>
            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                <button id="deleteConfirmCancelBtn" class="button" style="background: #e0e0e0; color: #333; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">Cancel</button>
                <button id="deleteConfirmBtn" class="button" style="background: #d32f2f; color: white; padding: 8px 16px; border: none; border-radius: 20px; cursor: pointer;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Image viewer modal -->
    <!-- ... existing code ... -->

    <!-- Import data module first to ensure data is available-->
    <script type="module" src="gardening_calendar/js/data-loader.js"></script>
    
    <!-- Import storage module -->
    <script type="module" src="gardening_calendar/js/storage-loader.js"></script>
    
    <!-- Import UI module -->
    <script type="module" src="gardening_calendar/js/ui-loader.js"></script>
    
    <!-- Add our refactored journal module after data is loaded -->
    <script type="module" src="gardening_calendar/js/journal-init.js"></script>

    <script>
        // The original script will remain here for now
        // As we refactor each part, we'll move it to its respective module
        // and remove it from here.
        
        // Multi-language support
        // translations object is now imported from the data module
        
        // Load additional languages dynamically
        async function loadLanguage(lang) {
            if (lang === 'en' || translations[lang]) {
                return translations[lang];
            }
            
            try {
                const response = await fetch(`gardening_calendar/translations/${lang}.json`);
                if (!response.ok) throw new Error(`Failed to load ${lang} translation`);
                const langData = await response.json();
                translations[lang] = langData;
                return langData;
            } catch (error) {
                console.error(`Error loading ${lang} translation:`, error);
                return null;
            }
        }
        
        // Current language (default to English)
        let currentLang = 'en';
        
        // Function to translate UI elements
        async function translateUI(lang) {
            // Load language if not already loaded
            const langData = await loadLanguage(lang);
            
            if (!langData) {
                console.error(`Translation for language ${lang} not found`);
                return;
            }
            
            currentLang = lang;
            const t = langData;
            
            // Save language preference
            localStorage.setItem('gardening_language', lang);
            
            // Update document title
            document.title = t.title;
            
            // Update text elements with data-i18n attributes
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            
            // Update placeholders for inputs
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (t[key]) {
                    el.setAttribute('placeholder', t[key]);
                }
            });
            
            // Update aria-labels
            document.querySelectorAll('[data-i18n-aria]').forEach(el => {
                const key = el.getAttribute('data-i18n-aria');
                if (t[key]) {
                    el.setAttribute('aria-label', t[key]);
                }
            });
            
            // Update month buttons
            document.querySelectorAll('.month-btn').forEach(btn => {
                const month = btn.getAttribute('data-month');
                if (t[month]) {
                    btn.textContent = t[month];
                }
            });
            
            // Update input placeholders
            if (t.location_placeholder) {
                locationInput.setAttribute('placeholder', t.location_placeholder);
            }
            
            // Update search box placeholder
            const searchBox = document.getElementById('searchBox');
            if (searchBox && t.search_placeholder) {
                searchBox.setAttribute('placeholder', t.search_placeholder);
            }
            
            // Update calendar data for current language
            renderCalendar(activeMonth, searchBox?.value || '');
        }
        
        // Function to get translated string
        function getTranslation(key) {
            return translations[currentLang]?.[key] || key;
        }
        
        // Initialize language from localStorage or browser preference
        async function initLanguage() {
            let savedLang = localStorage.getItem('gardening_language');
            
            if (!savedLang) {
                // Try to detect from browser
                const browserLang = navigator.language.split('-')[0];
                savedLang = ['en', 'et'].includes(browserLang) ? browserLang : 'en';
            }
            
            // Check if translations are available or wait for them
            if (window.translations) {
                await translateUI(savedLang);
            } else {
                // If translations aren't available, wait for data module to load
                document.addEventListener('dataModuleLoaded', async function() {
                    await translateUI(savedLang);
                });
            }
        }
        
        // Data in JSON format
        // calendarData is now imported from the data module

        // Category icons
        // categoryIcons is now imported from the data module

        // Category names
        // categoryNames is now imported from the data module

        // DOM elements
        const calendarContent = document.getElementById('calendarContent');
        const monthButtons = document.querySelectorAll('.month-btn');
        const searchBox = document.getElementById('searchBox');

        // Active month (default April)
        let activeMonth = 'april';

        // Track last actions for retry
        let lastGeocodeQuery = null;
        let lastWeatherCoords = null;
        let lastWeatherAction = null; // 'geocode' or 'weather'

        // Store last fetched weather data for re-rendering
        let lastWeatherData = null;
        let lastWeatherLat = null;
        let lastWeatherLon = null;

        // --- Köppen climate zone logic ---
        let koppenGrid = null;
        let userClimateZone = null;
        let userClimateZoneOverride = null;
        const climateZoneInfo = document.getElementById('climateZoneInfo');

        // Load the grid JSON
        fetch('gardening_calendar/data/koppen_grid_0.5deg.json')
            .then(r => r.json())
            .then(data => {
                koppenGrid = data;
                // If we already have a location, try to show zone
                const cached = localStorage.getItem('gardening_last_location');
                if (cached) {
                    try {
                        const loc = JSON.parse(cached);
                        if (loc.type === 'coords' && loc.lat && loc.lon) {
                            showClimateZone(loc.lat, loc.lon);
                        }
                    } catch (e) {}
                }
            });

        // Helper: round to nearest 0.25
        function round025(x) {
            // Ensure x is a number and round to either .25 or .75
            const num = typeof x === 'string' ? parseFloat(x) : x;
            const decimal = num % 1;
            const whole = Math.floor(num);
            let rounded;
            if (decimal < 0.375) {
                rounded = 0.25;
            } else if (decimal < 0.875) {
                rounded = 0.75;
            } else {
                rounded = 0.25;
                return (whole + 1 + rounded).toFixed(2);
            }
            return (whole + rounded).toFixed(2);
        }

        // Show climate zone info
        function showClimateZone(lat, lon) {
            if (!koppenGrid) {
                climateZoneInfo.innerHTML = '';
                return;
            }
            // Check for override
            const override = localStorage.getItem('gardening_climate_zone_override');
            let lookupKey = '';
            let foundZone = '';
            if (override) {
                userClimateZoneOverride = override;
                userClimateZone = override;
                lookupKey = '(override)';
                foundZone = override;
            } else {
                const latNum = typeof lat === 'string' ? parseFloat(lat) : lat;
                const lonNum = typeof lon === 'string' ? parseFloat(lon) : lon;
                const key = `${round025(latNum)} ${round025(lonNum)}`;
                // Try exact match first
                if (koppenGrid[key]) {
                    userClimateZone = koppenGrid[key];
                    lookupKey = key;
                    foundZone = userClimateZone;
                } else {
                    // Find nearest neighbor
                    const roundedLat = round025(latNum);
                    const roundedLon = round025(lonNum);
                    let minDistance = Infinity;
                    let nearestZone = null;
                    let nearestKey = null;
                    
                    // Search in nearby coordinates (±1 degree should be enough)
                    for (const gridKey in koppenGrid) {
                        const [gridLat, gridLon] = gridKey.split(' ').map(Number);
                        if (Math.abs(gridLat - roundedLat) <= 1 && Math.abs(gridLon - roundedLon) <= 1) {
                            const distance = Math.sqrt(
                                Math.pow(gridLat - roundedLat, 2) + 
                                Math.pow(gridLon - roundedLon, 2)
                            );
                            if (distance < minDistance) {
                                minDistance = distance;
                                nearestZone = koppenGrid[gridKey];
                                nearestKey = gridKey;
                            }
                        }
                    }
                    
                    if (nearestZone) {
                        userClimateZone = nearestZone;
                        lookupKey = `${key} (nearest: ${nearestKey}, dist: ${minDistance.toFixed(2)}°)`;
                        foundZone = nearestZone;
                    } else {
                        userClimateZone = 'Unknown';
                        lookupKey = key;
                        foundZone = 'Unknown';
                    }
                }
            }
            renderClimateZoneUI(lookupKey, foundZone);
        }

        // Render the climate zone UI (with debug info)
        function renderClimateZoneUI(lookupKey = '', foundZone = '') {
            let html = '';
            if (userClimateZone) {
                html += `<div style="margin-top: 15px; padding: 10px 15px; background: var(--white); border-radius: 8px; box-shadow: 0 1px 3px var(--shadow);">`;
                html += `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">`;
                html += `<strong>Climate zone:</strong> <span id="climateZoneCode" style="background: var(--light-bg); padding: 2px 8px; border-radius: 4px; font-family: monospace;">${userClimateZone}</span>`;
                html += `<a href="https://en.wikipedia.org/wiki/K%C3%B6ppen_climate_classification" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 0.95em;">(What is this?)</a>`;
                html += `</div>`;
                html += `<div style="display: flex; align-items: center; gap: 10px;">`;
                html += `<label for="climateZoneOverride" style="font-size: 0.95em;">Override zone:</label>`;
                html += `<input id="climateZoneOverride" type="text" style="padding: 4px 8px; border: 1px solid var(--secondary-color); border-radius: 4px; width: 60px;" value="${userClimateZoneOverride || ''}" placeholder="e.g. Dfb">`;
                html += `<button id="setClimateZoneOverrideBtn" style="padding: 4px 10px; background: var(--secondary-color); color: white; border: none; border-radius: 4px; font-size: 0.95em; cursor: pointer;">Set</button>`;
                html += `<button id="clearClimateZoneOverrideBtn" style="padding: 4px 10px; background: var(--accent-color); color: white; border: none; border-radius: 4px; font-size: 0.95em; cursor: pointer;">Clear</button>`;
                html += `</div></div>`;
            }
            climateZoneInfo.innerHTML = html;

            // Add listeners
            const setBtn = document.getElementById('setClimateZoneOverrideBtn');
            const clearBtn = document.getElementById('clearClimateZoneOverrideBtn');
            if (setBtn) {
                setBtn.addEventListener('click', function() {
                    const val = document.getElementById('climateZoneOverride').value.trim();
                    if (val) {
                        localStorage.setItem('gardening_climate_zone_override', val);
                        userClimateZoneOverride = val;
                        userClimateZone = val;
                        renderClimateZoneUI();
                    }
                });
            }
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    localStorage.removeItem('gardening_climate_zone_override');
                    userClimateZoneOverride = null;
                    // Recompute from location
                    const cached = localStorage.getItem('gardening_last_location');
                    if (cached) {
                        try {
                            const loc = JSON.parse(cached);
                            if (loc.type === 'coords' && loc.lat && loc.lon) {
                                const latNum = typeof loc.lat === 'string' ? parseFloat(loc.lat) : loc.lat;
                                const lonNum = typeof loc.lon === 'string' ? parseFloat(loc.lon) : loc.lon;
                                showClimateZone(latNum, lonNum);
                                return;
                            }
                        } catch (e) {}
                    }
                    renderClimateZoneUI();
                });
            }
        }

        // Helper: Convert temperature and precipitation
        function convertTemp(val, unit) {
            if (unit === 'F') return Math.round(val * 9/5 + 32);
            return Math.round(val);
        }
        function convertPrecip(val, unit) {
            if (unit === 'in') return (val / 25.4).toFixed(2);
            return val;
        }
        function getTempUnitSymbol() {
            return tempUnitSelect.value === 'F' ? '°F' : '°C';
        }
        function getPrecipUnitSymbol() {
            return precipUnitSelect.value === 'in' ? 'in' : 'mm';
        }

        // Function to render calendar content
        function renderCalendar(month, searchTerm = '') {
            // Clear content
            calendarContent.innerHTML = '';
            
            // Check if month has data
            if (!calendarData[month]) {
                calendarContent.innerHTML = `<div class="no-results">${getTranslation('no_data_available')}</div>`;
                return;
            }
            
            // Show categories
            const categories = Object.keys(calendarData[month]);
            
            // Filter for search
            let hasResults = false;
            let delay = 0;
            
            categories.forEach(category => {
                const items = calendarData[month][category];
                let filteredItems = items;
                
                // Apply filter if search term exists
                if (searchTerm) {
                    filteredItems = items.filter(item => {
                        const itemText = item[currentLang] || item.en;
                        return itemText.toLowerCase().includes(searchTerm.toLowerCase());
                    });
                }
                
                // Don't show category if no results after filtering
                if (filteredItems.length === 0 && searchTerm) {
                    return;
                }
                
                hasResults = true;
                
                // Create category card
                const categoryCard = document.createElement('div');
                const categoryClass = category === 'garden_tasks' ? 'category-card garden-tasks-card' : 'category-card';
                categoryCard.className = `${categoryClass} fade-in`;
                categoryCard.style.animationDelay = `${delay}ms`;
                delay += 100;
                
                // Icon and title
                const isTaskCategory = category === 'garden_tasks';
                const categoryDisplayName = translations[currentLang][category] || categoryNames[category] || category;
                
                categoryCard.innerHTML = `
                    <div class="category-header">
                        <div class="category-icon">${categoryIcons[category] || '🌿'}</div>
                        <h2 class="category-title">${categoryDisplayName}</h2>
                    </div>
                    <div class="select-all-container">
                        <label class="select-all-label">
                            <input type="checkbox" class="select-all-checkbox" data-category="${category}">
                            <span>Select All ${isTaskCategory ? 'Tasks' : 'Plants'}</span>
                        </label>
                    </div>
                    <ul class="plant-list">
                        ${filteredItems.map(item => {
                            const itemText = item[currentLang] || item.en;
                            const itemId = JSON.stringify(item); // Store the full item object
                            const displayText = searchTerm ? highlightText(itemText, searchTerm) : itemText;
                            
                            return `
                                <li class="${isTaskCategory ? 'task-item' : 'plant-item'}" data-item-id="${encodeURIComponent(itemId)}">
                                    <label class="item-label">
                                        <input type="checkbox" class="item-checkbox" 
                                            ${isItemSelected(month, category, item) ? 'checked' : ''}>
                                        <span class="item-text">${displayText}</span>
                                    </label>
                                </li>
                            `;
                        }).join('')}
                    </ul>
                `;

                // Add event listeners for checkboxes
                categoryCard.querySelectorAll('.item-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const itemJson = decodeURIComponent(e.target.closest('li').dataset.itemId);
                        const item = JSON.parse(itemJson);
                        toggleItemSelection(month, category, item, e.target.checked);
                        // Update the "Select All" checkbox status
                        updateSelectAllCheckbox(month, category);
                    });
                });
                
                calendarContent.appendChild(categoryCard);
            });
            
            // If no results found
            if (!hasResults) {
                calendarContent.innerHTML = `<div class="no-results">${translations[currentLang].no_results || 'No results found for your search.'}</div>`;
            }

            // Add event listeners for "Select All" checkboxes
            const selectAllCheckboxes = document.querySelectorAll('.select-all-checkbox');
            selectAllCheckboxes.forEach(checkbox => {
                const category = checkbox.dataset.category;
                
                // Initial state: check if all items are selected
                const categoryItems = calendarData[month][category] || [];
                if (categoryItems.length > 0) {
                    // Check if ALL items in this category are selected
                    let allSelected = true;
                    for (let i = 0; i < categoryItems.length; i++) {
                        if (!isItemSelected(month, category, categoryItems[i])) {
                            allSelected = false;
                            break;
                        }
                    }
                    checkbox.checked = allSelected;
                    console.log(`Initializing "Select All" for ${category}: ${allSelected}`);
                }
                
                // Add change event
                checkbox.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const categoryCard = e.target.closest('.category-card');
                    const checkboxes = categoryCard.querySelectorAll('.item-checkbox');
                    
                    // Update all checkboxes in this category
                    checkboxes.forEach(itemCheckbox => {
                        if (itemCheckbox.checked !== isChecked) {
                            itemCheckbox.checked = isChecked;
                            
                            // Get and update the item
                            const itemLi = itemCheckbox.closest('li');
                            const itemJson = decodeURIComponent(itemLi.dataset.itemId);
                            const item = JSON.parse(itemJson);
                            toggleItemSelection(month, category, item, isChecked);
                        }
                    });
                    
                    // Update the "Select All" checkbox status once after all items are processed
                    updateSelectAllCheckbox(month, category);
                });
            });
        }

        // Search function
        function searchCalendar() {
            const searchTerm = searchBox.value.trim();
            renderCalendar(activeMonth, searchTerm);
        }

        // Text highlighting function
        function highlightText(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
            return text.replace(regex, '<span class="highlight">$1</span>');
        }

        // Escape special characters in regular expression
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Listen for month button clicks
        monthButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all buttons
                monthButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                button.classList.add('active');
                
                // Update active month
                activeMonth = button.dataset.month;
                
                // Show calendar
                searchBox.value = ''; // Reset search
                renderCalendar(activeMonth);
            });
        });

        // Listen for search input
        searchBox.addEventListener('input', searchCalendar);

        // Initial calendar display - wait for data module to be loaded
        let calendarInitialized = false;
        if (window.calendarData) {
            // If data is already loaded, render immediately
            renderCalendar(activeMonth);
            calendarInitialized = true;
        } else {
            // Otherwise, wait for the data module to be loaded
            document.addEventListener('dataModuleLoaded', function() {
                if (!calendarInitialized) {
                    console.log('Data module loaded, initializing calendar');
                    renderCalendar(activeMonth);
                    calendarInitialized = true;
                }
            });
        }

        // Weather/location handling
        const locationInput = document.getElementById('locationInput');
        const useMyLocationBtn = document.getElementById('useMyLocationBtn');
        const weatherPlaceholder = document.getElementById('weatherPlaceholder');

        // Helper: Display error with optional retry
        function displayLocationError(msg, retryType = null) {
            let retryBtn = '';
            if (retryType === 'geocode') {
                retryBtn = '<button id="retryGeocodeBtn" style="margin-left:12px;">Retry</button>';
            } else if (retryType === 'weather') {
                retryBtn = '<button id="retryWeatherBtn" style="margin-left:12px;">Retry</button>';
            }
            weatherPlaceholder.innerHTML = `<div role="alert" style="color: #b71c1c;">${msg}${retryBtn}</div>`;
            if (retryType === 'geocode') {
                const btn = document.getElementById('retryGeocodeBtn');
                if (btn) btn.onclick = () => {
                    if (lastGeocodeQuery) geocodeLocation(lastGeocodeQuery, true);
                };
            } else if (retryType === 'weather') {
                const btn = document.getElementById('retryWeatherBtn');
                if (btn) btn.onclick = () => {
                    if (lastWeatherCoords) fetchWeatherData(lastWeatherCoords.lat, lastWeatherCoords.lon, true);
                };
            }
        }

        // Helper: Display location and coordinates, then fetch and display weather
        function displayLocationInfo(name, lat, lon, admin1, admin2, country) {
            let locationParts = [];
            if (name) locationParts.push(name);
            if (admin2) locationParts.push(admin2);
            if (admin1) locationParts.push(admin1);
            if (country) locationParts.push(country);
            const locationString = locationParts.join(', ');
            weatherPlaceholder.innerHTML =
                `<div class="weather-location-info"><strong>Location:</strong> ${locationString}<br><br>` +
                `<span style="font-size:0.97em;color:#666;">Latitude: ${lat}, Longitude: ${lon}</span></div>` +
                `<div id="weatherDataSection">Loading weather data...</div>`;
            lastWeatherCoords = { lat, lon };
            lastWeatherAction = 'weather';
            fetchWeatherData(lat, lon);
            showClimateZone(lat, lon);
        }

        // Weather code to icon, text, and color (Open-Meteo codes)
        function weatherCodeToIconTextColor(code) {
            // Weather type to color mapping
            const typeColors = {
                sun:   { bg: '#fffde7', color: '#fbc02d' },
                cloud: { bg: '#eceff1', color: '#607d8b' },
                rain:  { bg: '#e3f2fd', color: '#1976d2' },
                snow:  { bg: '#f3e5f5', color: '#7e57c2' },
                storm: { bg: '#ffe0b2', color: '#e65100' },
                fog:   { bg: '#f5f5f5', color: '#757575' },
                unknown: { bg: '#eeeeee', color: '#888' }
            };
            // Map weather code to icon, text, and type
            const map = {
                0:  {icon: '☀️', text: 'Clear sky', type: 'sun'},
                1:  {icon: '🌤️', text: 'Mainly clear', type: 'sun'},
                2:  {icon: '⛅', text: 'Partly cloudy', type: 'cloud'},
                3:  {icon: '☁️', text: 'Overcast', type: 'cloud'},
                45: {icon: '🌫️', text: 'Fog', type: 'fog'},
                48: {icon: '🌫️', text: 'Rime fog', type: 'fog'},
                51: {icon: '🌦️', text: 'Light drizzle', type: 'rain'},
                53: {icon: '🌦️', text: 'Drizzle', type: 'rain'},
                55: {icon: '🌦️', text: 'Dense drizzle', type: 'rain'},
                56: {icon: '🌧️', text: 'Freezing light drizzle', type: 'rain'},
                57: {icon: '🌧️', text: 'Freezing drizzle', type: 'rain'},
                61: {icon: '🌦️', text: 'Slight rain', type: 'rain'},
                63: {icon: '🌧️', text: 'Rain', type: 'rain'},
                65: {icon: '🌧️', text: 'Heavy rain', type: 'rain'},
                66: {icon: '🌧️', text: 'Freezing light rain', type: 'rain'},
                67: {icon: '🌧️', text: 'Freezing rain', type: 'rain'},
                71: {icon: '🌨️', text: 'Slight snow fall', type: 'snow'},
                73: {icon: '🌨️', text: 'Snow fall', type: 'snow'},
                75: {icon: '❄️', text: 'Heavy snow fall', type: 'snow'},
                77: {icon: '❄️', text: 'Snow grains', type: 'snow'},
                80: {icon: '🌦️', text: 'Slight rain showers', type: 'rain'},
                81: {icon: '🌧️', text: 'Rain showers', type: 'rain'},
                82: {icon: '🌧️', text: 'Violent rain showers', type: 'rain'},
                85: {icon: '🌨️', text: 'Slight snow showers', type: 'snow'},
                86: {icon: '🌨️', text: 'Snow showers', type: 'snow'},
                95: {icon: '⛈️', text: 'Thunderstorm', type: 'storm'},
                96: {icon: '⛈️', text: 'Thunderstorm w/ hail', type: 'storm'},
                99: {icon: '⛈️', text: 'Thunderstorm w/ heavy hail', type: 'storm'}
            };
            const entry = map[code] || {icon: '❓', text: 'Unknown', type: 'unknown'};
            const color = typeColors[entry.type] || typeColors.unknown;
            return { ...entry, ...color };
        }

        // Fetch weather data from Open-Meteo
        async function fetchWeatherData(lat, lon, isRetry = false) {
            lastWeatherCoords = { lat, lon };
            lastWeatherAction = 'weather';
            lastWeatherLat = lat;
            lastWeatherLon = lon;
            const weatherSection = document.getElementById('weatherDataSection');
            if (!weatherSection) return;
            weatherSection.textContent = 'Loading weather data...';
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,weathercode&hourly=temperature_2m,precipitation,windspeed_10m&forecast_days=16&timezone=auto`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Weather service error');
                const data = await response.json();
                lastWeatherData = data;
                if (!data.current_weather || !data.daily || !data.hourly) {
                    weatherSection.innerHTML = '<div role="alert" style="color: #b71c1c;">Weather data not available for this location.</div>';
                    return;
                }
                renderWeatherData(data);
            } catch (e) {
                if (weatherSection) {
                    weatherSection.innerHTML = '<div role="alert" style="color: #b71c1c;">Could not fetch weather data. <button id="retryWeatherBtn" style="margin-left:12px;">Retry</button></div>';
                    const btn = document.getElementById('retryWeatherBtn');
                    if (btn) btn.onclick = () => {
                        if (lastWeatherCoords) fetchWeatherData(lastWeatherCoords.lat, lastWeatherCoords.lon, true);
                    };
                }
            }
        }

        // Render weather data in selected units
        function renderWeatherData(data) {
            const weatherSection = document.getElementById('weatherDataSection');
            if (!weatherSection) return;
            const tempUnit = tempUnitSelect.value;
            const precipUnit = precipUnitSelect.value;
            // Display current weather
            const currentIconTextColor = weatherCodeToIconTextColor(data.current_weather.weathercode);
            let html = `<div class="weather-current"><strong>Current weather:</strong> <span style="display:inline-block;background:${currentIconTextColor.bg};border-radius:50%;padding:6px 10px;font-size:1.4em;color:${currentIconTextColor.color};margin-right:6px;">${currentIconTextColor.icon}</span> ${currentIconTextColor.text}, ${convertTemp(data.current_weather.temperature, tempUnit)}${getTempUnitSymbol()}, Wind: ${data.current_weather.windspeed} km/h</div>`;
            // Prepare hourly data grouped by day
            const hourlyByDay = groupHourlyByDay(data.hourly, data.daily.time);
            const hourlyPrecipByDay = groupHourlyByDay({ time: data.hourly.time, temperature_2m: data.hourly.precipitation }, data.daily.time);
            const hourlyWindByDay = groupHourlyByDay({ time: data.hourly.time, temperature_2m: data.hourly.windspeed_10m }, data.daily.time);
            // Display forecast table
            html += `<div style="margin-top:10px;"><strong>16-day forecast:</strong></div>`;
            html += `<table class="weather-forecast-table"><caption class='visually-hidden'>16-day weather forecast for selected location</caption><thead><tr><th scope='col'>Date</th><th scope='col'>Night Min</th><th scope='col'>Night Max</th><th scope='col'>Day Min</th><th scope='col'>Day Max</th><th scope='col'>Precip.</th><th scope='col'>Weather</th><th scope='col'>Temp Trend</th></tr></thead><tbody>`;
            for (let i = 0; i < data.daily.time.length; i++) {
                const { nightMin, nightMax, dayMin, dayMax } = calcNightDayMinMax(hourlyByDay[i]);
                const weatherIconTextColor = weatherCodeToIconTextColor(data.daily.weathercode[i]);
                
                // Color-code the temperature cells
                function getTempHtml(tempValue) {
                    if (tempValue === null) return '-';
                    const temp = convertTemp(tempValue, tempUnit);
                    const tempColor = getTemperatureColor(temp, tempUnit);
                    
                    // Calculate contrasting text color (black or white) based on background color
                    // Convert hex color to RGB to calculate luminance
                    const hexToRgb = (hex) => {
                        const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                        const fullHex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
                        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
                        return result ? {
                            r: parseInt(result[1], 16),
                            g: parseInt(result[2], 16),
                            b: parseInt(result[3], 16)
                        } : {r: 0, g: 0, b: 0};
                    };
                    
                    // Calculate relative luminance for accessibility contrast
                    const rgb = hexToRgb(tempColor);
                    
                    // Use the original color but with reduced opacity for a softer look
                    const bgColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25)`;
                    const textColor = '#333333';
                    const borderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                    
                    return `<span style="display:inline-block;background-color:${bgColor};color:${textColor};padding:2px 6px;border-radius:4px;font-weight:500;border:1px solid ${borderColor};">${temp}${getTempUnitSymbol()}</span>`;
                }
                
                html += `<tr>
                    <td>${data.daily.time[i]}</td>
                    <td>${getTempHtml(nightMin)}</td>
                    <td>${getTempHtml(nightMax)}</td>
                    <td>${getTempHtml(dayMin)}</td>
                    <td>${getTempHtml(dayMax)}</td>
                    <td>${convertPrecip(data.daily.precipitation_sum[i], precipUnit)} ${getPrecipUnitSymbol()}</td>
                    <td><span style='display:inline-block;background:${weatherIconTextColor.bg};border-radius:50%;padding:7px 12px;font-size:1.5em;color:${weatherIconTextColor.color};margin-bottom:2px;'>${weatherIconTextColor.icon}</span><br><span style='color:${weatherIconTextColor.color};font-size:0.93em;'>${weatherIconTextColor.text}</span></td>
                    <td>${renderSparkline(hourlyByDay[i], i, tempUnit)}</td>
                </tr>`;
            }
            html += `</tbody></table>`;
            weatherSection.innerHTML = html;
            // Add event listeners for sparklines
            addSparklineListeners(hourlyByDay, data.daily.time, hourlyPrecipByDay, hourlyWindByDay, tempUnit, precipUnit);
        }

        // Calculate night and day min/max for a day's hourly temps
        function calcNightDayMinMax(temps) {
            if (!temps || temps.length !== 24) return { nightMin: null, nightMax: null, dayMin: null, dayMax: null };
            // Night: 21:00–23:00 (21,22,23) and 00:00–05:00 (0,1,2,3,4,5)
            const nightHours = [21,22,23,0,1,2,3,4,5];
            const dayHours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20];
            const nightTemps = nightHours.map(h => temps[h]).filter(t => t !== undefined);
            const dayTemps = dayHours.map(h => temps[h]).filter(t => t !== undefined);
            return {
                nightMin: nightTemps.length ? Math.round(Math.min(...nightTemps)) : null,
                nightMax: nightTemps.length ? Math.round(Math.max(...nightTemps)) : null,
                dayMin: dayTemps.length ? Math.round(Math.min(...dayTemps)) : null,
                dayMax: dayTemps.length ? Math.round(Math.max(...dayTemps)) : null
            };
        }

        // Group hourly temperature data by day
        function groupHourlyByDay(hourly, dailyDates) {
            const result = [];
            const hours = hourly.time;
            const temps = hourly.temperature_2m;
            let dayIndex = 0;
            let currentDay = dailyDates[dayIndex];
            let dayTemps = [];
            for (let i = 0; i < hours.length; i++) {
                if (hours[i].startsWith(currentDay)) {
                    dayTemps.push(temps[i]);
                } else {
                    result.push(dayTemps);
                    dayTemps = [];
                    dayIndex++;
                    currentDay = dailyDates[dayIndex];
                    if (!currentDay) break;
                    if (hours[i].startsWith(currentDay)) {
                        dayTemps.push(temps[i]);
                    }
                }
            }
            if (dayTemps.length) result.push(dayTemps);
            return result;
        }

        // Shared temperature color mapping function
        function getTemperatureColor(temp, tempUnit) {
            // Define more granular temperature steps
            const temperatureSteps = tempUnit === 'F' ? [
                { threshold: 14, color: '#0d47a1' },   // Very cold (deep blue)
                { threshold: 23, color: '#1565c0' },   // Freezing (deep blue-mid blue)
                { threshold: 32, color: '#1976d2' },   // Freezing point (mid blue)
                { threshold: 41, color: '#1e88e5' },   // Cold (blue)
                { threshold: 50, color: '#42a5f5' },   // Cool (light blue)
                { threshold: 59, color: '#64b5f6' },   // Cool-mild (pale blue)
                { threshold: 64, color: '#81c784' },   // Mild (light green)
                { threshold: 68, color: '#4caf50' },   // Mild-comfortable (medium green)
                { threshold: 73, color: '#7cb342' },   // Comfortable (green-yellow)
                { threshold: 77, color: '#9e9d24' },   // Warm (yellow-green)
                { threshold: 82, color: '#ffb74d' },   // Warm-hot (light orange)
                { threshold: 86, color: '#ff9800' },   // Hot (orange)
                { threshold: 91, color: '#f57c00' },   // Very hot (dark orange)
                { threshold: 95, color: '#e64a19' },   // Extremely hot (orange-red)
                { threshold: 100, color: '#d32f2f' },  // Dangerous heat (red)
                { threshold: Infinity, color: '#b71c1c' } // Extreme heat (deep red)
            ] : [
                { threshold: -20, color: '#0d47a1' },  // Extreme cold (deep blue)
                { threshold: -15, color: '#1565c0' },  // Very cold (deep blue-mid blue)
                { threshold: -10, color: '#1976d2' },  // Very cold (mid blue)
                { threshold: -5, color: '#1e88e5' },   // Cold (blue)
                { threshold: 0, color: '#42a5f5' },    // Freezing (light blue)
                { threshold: 5, color: '#64b5f6' },    // Cool (pale blue)
                { threshold: 10, color: '#81c784' },   // Cool-mild (light green)
                { threshold: 15, color: '#4caf50' },   // Mild (medium green)
                { threshold: 20, color: '#7cb342' },   // Comfortable (green-yellow)
                { threshold: 23, color: '#9e9d24' },   // Warm (yellow-green)
                { threshold: 26, color: '#ffb74d' },   // Warm-hot (light orange)
                { threshold: 30, color: '#ff9800' },   // Hot (orange)
                { threshold: 33, color: '#f57c00' },   // Very hot (dark orange)
                { threshold: 36, color: '#e64a19' },   // Extremely hot (orange-red)
                { threshold: 40, color: '#d32f2f' },   // Dangerous heat (red)
                { threshold: Infinity, color: '#b71c1c' } // Extreme heat (deep red)
            ];
            
            // Find the appropriate color based on temperature
            for (const step of temperatureSteps) {
                if (temp <= step.threshold) {
                    return step.color;
                }
            }
            return '#b71c1c'; // Fallback to deepest red
        }

        // Render a mini SVG sparkline for a day's temperatures
        function renderSparkline(temps, dayIndex, tempUnit) {
            if (!temps || temps.length === 0) return '';
            const w = 60, h = 40;
            // Convert all temps for sparkline
            const convertedTemps = temps.map(t => convertTemp(t, tempUnit));
            
            // Use absolute temperature ranges for consistent coloring
            // -10°C (14°F) to 40°C (104°F) is a reasonable range for most weather
            const absMinTemp = tempUnit === 'F' ? 14 : -10;
            const absMaxTemp = tempUnit === 'F' ? 104 : 40;
            
            // Use local min/max for the height calculations only
            const min = Math.min(...convertedTemps);
            const max = Math.max(...convertedTemps);
            const range = max - min || 1;
            
            // Create a smooth curve using cubic bezier curves
            let path = '';
            const allPoints = [];
            let pathSegments = [];
            
            convertedTemps.forEach((t, i) => {
                const x = (i / (convertedTemps.length - 1)) * (w - 2) + 1;
                const y = h - 2 - ((t - min) / range) * (h - 4);
                allPoints.push({ x, y, temp: t });
            });
            
            // Build smooth path using cubic bezier curves
            if (allPoints.length > 0) {
                path = `M ${allPoints[0].x.toFixed(1)},${allPoints[0].y.toFixed(1)}`;
                
                for (let i = 0; i < allPoints.length - 1; i++) {
                    const current = allPoints[i];
                    const next = allPoints[i + 1];
                    
                    // Calculate control points for smooth curve
                    const cpx1 = current.x + (next.x - current.x) / 3;
                    const cpy1 = current.y;
                    const cpx2 = current.x + 2 * (next.x - current.x) / 3;
                    const cpy2 = next.y;
                    
                    const segment = `C${cpx1.toFixed(1)},${cpy1.toFixed(1)} ${cpx2.toFixed(1)},${cpy2.toFixed(1)} ${next.x.toFixed(1)},${next.y.toFixed(1)}`;
                    path += ` ${segment}`;
                    
                    // Store segment with average temperature for coloring
                    const avgTemp = (current.temp + next.temp) / 2;
                    pathSegments.push({
                        segment: segment,
                        temp: avgTemp,
                        startX: current.x,
                        endX: next.x
                    });
                }
            }
            
            // Reference lines for 0 and 20 (in selected unit)
            const y0 = h - 2 - ((convertTemp(0, tempUnit) - min) / range) * (h - 4);
            const y20 = h - 2 - ((convertTemp(20, tempUnit) - min) / range) * (h - 4);
            
            // Create multiple path elements with different colors based on temperature
            let coloredPaths = '';
            
            if (allPoints.length > 0) {
                // Don't start with an incomplete path
                
                pathSegments.forEach((segment, i) => {
                    const color = getTemperatureColor(segment.temp, tempUnit);
                    coloredPaths += `<path d="M ${segment.startX.toFixed(1)},${allPoints[i].y.toFixed(1)} ${segment.segment}" 
                        fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />`;
                });
            }
            
            return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" style="vertical-align:middle;cursor:pointer;" data-day-index="${dayIndex}">
                <polyline fill="none" stroke="#bbb" stroke-width="1" points="0,${y0.toFixed(1)} ${w},${y0.toFixed(1)}" opacity="0.5" />
                <polyline fill="none" stroke="#bbb" stroke-width="1" points="0,${y20.toFixed(1)} ${w},${y20.toFixed(1)}" opacity="0.5" />
                ${coloredPaths}
            </svg>`;
        }

        // Render a larger SVG chart for modal
        function renderLargeTempChart(temps, tempUnit) {
            if (!temps || temps.length === 0) return '';
            const w = 340, h = 100;
            // Convert all temps for chart
            const convertedTemps = temps.map(t => convertTemp(t, tempUnit));
            
            // Use absolute temperature ranges for consistent coloring
            // -10°C (14°F) to 40°C (104°F) is a reasonable range for most weather
            const absMinTemp = tempUnit === 'F' ? 14 : -10;
            const absMaxTemp = tempUnit === 'F' ? 104 : 40;
            
            // Use local min/max for the height calculations only
            const min = Math.min(...convertedTemps);
            const max = Math.max(...convertedTemps);
            const range = max - min || 1;
            
            // Create a smooth curve using cubic bezier curves
            let path = '';
            const allPoints = [];
            let pathSegments = [];
            
            convertedTemps.forEach((t, i) => {
                const x = (i / (convertedTemps.length - 1)) * (w - 2) + 1;
                const y = h - 20 - ((t - min) / range) * (h - 40);
                allPoints.push({ x, y, temp: t });
            });
            
            // Build smooth path using cubic bezier curves
            if (allPoints.length > 0) {
                path = `M ${allPoints[0].x.toFixed(1)},${allPoints[0].y.toFixed(1)}`;
                
                for (let i = 0; i < allPoints.length - 1; i++) {
                    const current = allPoints[i];
                    const next = allPoints[i + 1];
                    
                    // Calculate control points for smooth curve
                    const cpx1 = current.x + (next.x - current.x) / 3;
                    const cpy1 = current.y;
                    const cpx2 = current.x + 2 * (next.x - current.x) / 3;
                    const cpy2 = next.y;
                    
                    const segment = `C${cpx1.toFixed(1)},${cpy1.toFixed(1)} ${cpx2.toFixed(1)},${cpy2.toFixed(1)} ${next.x.toFixed(1)},${next.y.toFixed(1)}`;
                    path += ` ${segment}`;
                    
                    // Store segment with average temperature for coloring
                    const avgTemp = (current.temp + next.temp) / 2;
                    pathSegments.push({
                        segment: segment,
                        temp: avgTemp,
                        startX: current.x,
                        endX: next.x
                    });
                }
            }
            
            // Reference lines for 0 and 20 (in selected unit)
            const y0 = h - 20 - ((convertTemp(0, tempUnit) - min) / range) * (h - 40);
            const y20 = h - 20 - ((convertTemp(20, tempUnit) - min) / range) * (h - 40);
            const minLabel = min + getTempUnitSymbol();
            const maxLabel = max + getTempUnitSymbol();
            
            // Create multiple path elements with different colors based on temperature
            let coloredPaths = '';
            
            if (allPoints.length > 0) {
                // Don't start with an incomplete path
                
                pathSegments.forEach((segment, i) => {
                    const color = getTemperatureColor(segment.temp, tempUnit);
                    coloredPaths += `<path d="M ${segment.startX.toFixed(1)},${allPoints[i].y.toFixed(1)} ${segment.segment}" 
                        fill="none" stroke="${color}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />`;
                });
            }
            
            return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
                <polyline fill="none" stroke="#bbb" stroke-width="1" points="0,${y0.toFixed(1)} ${w},${y0.toFixed(1)}" opacity="0.5" />
                <polyline fill="none" stroke="#bbb" stroke-width="1" points="0,${y20.toFixed(1)} ${w},${y20.toFixed(1)}" opacity="0.5" />
                ${coloredPaths}
                <text x="2" y="${h - 22}" font-size="11" fill="#888">${minLabel}</text>
                <text x="2" y="18" font-size="11" fill="#888">${maxLabel}</text>
            </svg>`;
        }

        // Show modal with detailed chart and hourly temps
        function showWeatherModal(dayIndex, date, temps, precips, winds) {
            // Track weather detail view in Google Analytics
            if (typeof gtag === 'function') {
                gtag('event', 'view_weather_details', {
                    'date': date,
                    'day_index': dayIndex
                });
            }
            
            // Build hourly table
            const tempUnit = tempUnitSelect.value;
            const precipUnit = precipUnitSelect.value;
            let hourlyTable = '<table class="weather-modal-hourly-table"><thead><tr><th>Hour</th><th>Temp (' + getTempUnitSymbol() + ')</th><th>Precip. (' + getPrecipUnitSymbol() + ')</th><th>Wind (km/h)</th></tr></thead><tbody>';
            for (let h = 0; h < temps.length; h++) {
                // Color-code the temperature cell
                const temp = convertTemp(temps[h], tempUnit);
                const tempColor = getTemperatureColor(temp, tempUnit);
                
                // Calculate contrasting text color (black or white) based on background color
                const hexToRgb = (hex) => {
                    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
                    const fullHex = hex.replace(shorthandRegex, (m, r, g, b) => r + r + g + g + b + b);
                    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(fullHex);
                    return result ? {
                        r: parseInt(result[1], 16),
                        g: parseInt(result[2], 16),
                        b: parseInt(result[3], 16)
                    } : {r: 0, g: 0, b: 0};
                };
                
                // Calculate relative luminance for accessibility contrast
                const rgb = hexToRgb(tempColor);
                
                // Use the original color but with reduced opacity for a softer look
                const bgColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.25)`;
                const textColor = '#333333';
                const borderColor = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`;
                
                const tempHtml = `<span style="display:inline-block;background-color:${bgColor};color:${textColor};padding:2px 6px;border-radius:4px;font-weight:500;width:100%;border:1px solid ${borderColor};">${temp}${getTempUnitSymbol()}</span>`;
                
                hourlyTable += `<tr>
                    <td>${h}:00</td>
                    <td>${tempHtml}</td>
                    <td>${precips && precips[h] !== undefined ? convertPrecip(precips[h], precipUnit) : '-'}</td>
                    <td>${winds && winds[h] !== undefined ? Math.round(winds[h]) : '-'}</td>
                </tr>`;
            }
            hourlyTable += '</tbody></table>';
            
            // Create modal content
            const modalContent = `
                <div class="weather-modal-chart">${renderLargeTempChart(temps, tempUnit)}</div>
                ${hourlyTable}
            `;
            
            // Use the UI module's showModal function
            showModal(`Hourly Weather for ${date}`, modalContent, {
                maxWidth: '800px',
                id: 'weatherModalOverlay',
                showCloseButton: true,
                closeOnEscape: true,
                closeOnOutsideClick: true
            });
        }

        // Add event delegation for sparkline clicks after weather table is rendered
        function addSparklineListeners(hourlyByDay, dailyDates, hourlyPrecipByDay, hourlyWindByDay, tempUnit, precipUnit) {
            const table = document.querySelector('.weather-forecast-table');
            if (!table) return;
            table.addEventListener('click', function(e) {
                const svg = e.target.closest('svg[data-day-index]');
                if (svg) {
                    const dayIndex = parseInt(svg.getAttribute('data-day-index'));
                    if (!isNaN(dayIndex) && hourlyByDay[dayIndex]) {
                        showWeatherModal(
                            dayIndex,
                            dailyDates[dayIndex],
                            hourlyByDay[dayIndex],
                            hourlyPrecipByDay ? hourlyPrecipByDay[dayIndex] : null,
                            hourlyWindByDay ? hourlyWindByDay[dayIndex] : null
                        );
                    }
                }
            });
        }

        // On page load, check for cached location
        window.addEventListener('DOMContentLoaded', () => {
            const cached = localStorage.getItem('gardening_last_location');
            if (cached) {
                try {
                    const loc = JSON.parse(cached);
                    if (loc.type === 'query' && loc.value) {
                        locationInput.value = loc.value;
                        // Update clear button opacity
                        clearLocationBtn.style.opacity = '0.7';
                        geocodeLocation(loc.value);
                    } else if (loc.type === 'coords' && loc.lat && loc.lon) {
                        // Clear the input when using coordinates
                        locationInput.value = '';
                        clearLocationBtn.style.opacity = '0.2';
                        displayLocationInfo('Your location', loc.lat, loc.lon, '', '', '');
                    }
                } catch (e) {}
            }
        });
        
        // Handle clear button logic and input events
        const clearLocationBtn = document.getElementById('clearLocationBtn');
        
        // Show/hide clear button based on input content
        locationInput.addEventListener('input', function() {
            clearLocationBtn.style.opacity = this.value ? '0.7' : '0.2';
        });
        
        // Clear input when clear button is clicked
        clearLocationBtn.addEventListener('click', function() {
            locationInput.value = '';
            locationInput.focus();
            clearLocationBtn.style.opacity = '0.2';
        });
        
        // Set initial opacity for clear button
        clearLocationBtn.style.opacity = locationInput.value ? '0.7' : '0.2';
        
        // We're now using a single placeholder format for consistency

        // Geocoding API call
        async function geocodeLocation(query, isRetry = false) {
            // Track location search in Google Analytics
            if (typeof gtag === 'function' && !isRetry) {
                gtag('event', 'search_location', {
                    'search_term': query
                });
            }
            
            lastGeocodeQuery = query;
            lastWeatherAction = 'geocode';
            weatherPlaceholder.textContent = 'Looking up location...';
            // Cache the query
            localStorage.setItem('gardening_last_location', JSON.stringify({ type: 'query', value: query }));
            try {
                const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Geocoding service error');
                const data = await response.json();
                if (!data.results || data.results.length === 0) {
                    displayLocationError('Location not found. Please try a different name or postal code.', 'geocode');
                    return;
                }
                const result = data.results[0];
                displayLocationInfo(
                    result.name,
                    result.latitude,
                    result.longitude,
                    result.admin1,
                    result.admin2,
                    result.country
                );
            } catch (e) {
                displayLocationError('Could not resolve location. Please check your input and try again.', 'geocode');
            }
        }

        // Handle location input and search
        const searchLocationBtn = document.getElementById('searchLocationBtn');
        
        // Search when clicking the search button
        searchLocationBtn.addEventListener('click', function() {
            const query = locationInput.value.trim();
            if (query) geocodeLocation(query);
        });
        
        // Search when pressing Enter
        locationInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const query = locationInput.value.trim();
                if (query) geocodeLocation(query);
            }
        });
        
        // We no longer search on blur to avoid unexpected behavior
        // This makes the UX more explicit - users must press Enter or the Search button

        // Handle 'Use my location' button
        useMyLocationBtn.addEventListener('click', function() {
            // Clear the input field when using geolocation
            locationInput.value = '';
            
            weatherPlaceholder.textContent = 'Getting your location...';
            if (!navigator.geolocation) {
                displayLocationError('Geolocation is not supported by your browser.', 'geocode');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude.toFixed(5);
                    const lon = pos.coords.longitude.toFixed(5);
                    // Cache the coordinates
                    localStorage.setItem('gardening_last_location', JSON.stringify({ type: 'coords', lat, lon }));
                    displayLocationInfo('Your location', lat, lon, '', '', '');
                },
                (err) => {
                    displayLocationError('Could not get your location. Please allow location access or enter a place name.', 'geocode');
                }
            );
        });

        // Unit preference logic
        const tempUnitSelect = document.getElementById('tempUnitSelect');
        const precipUnitSelect = document.getElementById('precipUnitSelect');
        
        // Load preferences from localStorage using the storage module
        function loadUnitPrefs() {
            // Use the storage module utility functions
            const temp = storageUtils.getTemperatureUnit();
            const precip = storageUtils.getPrecipitationUnit();
            
            tempUnitSelect.value = temp;
            precipUnitSelect.value = precip;
        }
        
        // Save preferences to localStorage
        tempUnitSelect.addEventListener('change', () => {
            storageUtils.saveTemperatureUnit(tempUnitSelect.value);
            // Track event in Google Analytics
            if (typeof gtag === 'function') {
                gtag('event', 'change_preference', {
                    'preference_type': 'temperature_unit',
                    'value': tempUnitSelect.value
                });
            }
            if (lastWeatherData) renderWeatherData(lastWeatherData);
        });
        
        precipUnitSelect.addEventListener('change', () => {
            storageUtils.savePrecipitationUnit(precipUnitSelect.value);
            // Track event in Google Analytics
            if (typeof gtag === 'function') {
                gtag('event', 'change_preference', {
                    'preference_type': 'precipitation_unit',
                    'value': precipUnitSelect.value
                });
            }
            if (lastWeatherData) renderWeatherData(lastWeatherData);
        });
        
        // Language is now fixed to English
        
        // On page load, set unit preferences
        window.addEventListener('DOMContentLoaded', async () => {
            loadUnitPrefs();
            // Set fixed language to English
            currentLang = 'en';
            document.title = translations['en'].title;
            renderCalendar(activeMonth, searchBox?.value || '');
        });

        // Prompt Generator Logic
        const generatePromptBtn = document.getElementById('generatePromptBtn');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const customNotes = document.getElementById('customNotes');
        const generatedPrompt = document.getElementById('generatedPrompt');
        const includeCalendar = document.getElementById('includeCalendar');
        const includeRelevantPlantsOnly = document.getElementById('includeRelevantPlantsOnly');

        // Garden Journal functionality
        // ----------------------------

        // JOURNAL CODE HAS BEEN MOVED TO /gardening_calendar/js/modules/journal.js
        // Loading it via the loader script below

        // Weather, Calendar, and other JavaScript functionality continues...

        // Navigation functionality
        document.addEventListener('DOMContentLoaded', () => {
            const quickJumpMenu = document.getElementById('quickJumpMenu');
            
            // Handle navigation button clicks
            quickJumpMenu.addEventListener('click', (e) => {
                const btn = e.target.closest('.quick-jump-btn');
                if (!btn) return;
                
                // Set active state
                quickJumpMenu.querySelectorAll('.quick-jump-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Get target section
                const sectionId = btn.dataset.section;
                
                // Show/hide sections
                    if (sectionId === 'garden-journal') {
                    // Show only journal section
                        document.querySelectorAll('section').forEach(s => {
                            s.style.display = s.id === 'garden-journal' ? 'block' : 'none';
                        });
                    
                    // Render journal content - will be handled by the journal module
                    // since journal is displayed, the module's event listeners will detect 
                    // that it's visible and render the content
                    } else {
                    // Hide journal
                        document.getElementById('garden-journal').style.display = 'none';
                    
                    // Show other sections
                        document.querySelectorAll('section:not(#garden-journal)').forEach(s => {
                        s.style.display = 'block';
                    });
                    
                    // Scroll to the target section with offset for header
                    const targetSection = document.getElementById(sectionId);
                    if (targetSection) {
                        // Use the UI module's scrollToElement function
                        scrollToElement(targetSection, 200);
                    }
                }
            });
        });
        
        // JOURNAL CODE HAS BEEN MOVED TO /gardening_calendar/js/modules/journal.js
        // Loading it via the loader script below

        // Weather, Calendar, and other JavaScript functionality continues...
    </script>
    
    <!-- Journal Module Loader -->
    <script type="module" src="gardening_calendar/js/journal-loader.js"></script>
</body>
</html> 